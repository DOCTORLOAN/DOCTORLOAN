@using DOCTORLOAN.Models.Orders;
@{
    ViewData["Title"] = "Thanh Toán";
}

<section id="CartPayment" class="cart-payment">
    <div class="container">
        <div class="row">
            <form method="post" asp-controller="Cart" asp-action="PaymentPost" class="row needs-validation" novalidate>
                @if (TempData["AlertMessageError"] != null)
                {
                    <input type="text" class="form-control" value="@TempData["AlertMessageError"]" id="alertMessageError" hidden/>
                }
                <div class="col-lg-7">
                    <div class="cart-wrapper">
                        <div class="title-cart">Thông tin đơn hàng</div>
                        <div class="cart-link">Đã có tài khoản?&nbsp; <a asp-controller="Auth" asp-action="Login">Đăng nhập</a></div>
                        <div class="cart-form">
                            <div class="mb-3">
                                <label for="fullName" class="req">Tên người nhận</label>
                                <input type="text" class="form-control" placeholder="Nhập tên người nhận" name="FullName" id="fullName" required />
                                <div class="invalid-feedback">
                                    Vui lòng nhập họ tên.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="req">Số điện thoại</label>
                                <input type="text" class="form-control" placeholder="Nhập số điện thoại" name="Phone" id="phone" required />
                                <div class="invalid-feedback">
                                    Vui lòng nhập số điện thoại.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email">Email</label>
                                <input type="text" class="form-control" placeholder="Nhập email" name="Email" id="email" />
                            </div>

                            <div class="mb-3">
                                <label for="city" class="req">Thành Phố</label>
                                <select id="city" class="form-select" required>
                                    <option value="" selected>Chọn tỉnh thành</option>
                                </select>
                                <div class="invalid-feedback">
                                    Vui lòng chọn thành phố.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="District" class="req">Quận, Huyện</label>
                                <select id="district" class="form-select" required>
                                    <option value="" selected>Chọn quận huyện</option>
                                </select>
                                <div class="invalid-feedback">
                                    Vui lòng chọn Quận, huyện.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="ward" class="req">Xã, Phường</label>
                                <select id="ward" class="form-select" required>
                                    <option value="" selected>Chọn xã, phường</option>
                                </select>
                                <div class="invalid-feedback">
                                    Vui lòng chọn Xã, Phường.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="addressDetaills" class="req">Địa chỉ cụ thể</label>
                                <input type="text" class="form-control" placeholder="Số nhà - Tên Đường" id="addressDetaills" onfocusout="myFunction()" required  />
                                <div class="invalid-feedback">
                                    Vui lòng nhập địa chỉ cụ thể:
                                    <br/> - (Số nhà  - Tên Đường)
                                    <br/> - Tên địa danh (Thôn - Ấp - Làng,...)
                                </div>
                            </div>
                            
                            <input type="text" class="form-control" placeholder="Nhập địa chỉ" name="AddressLine" id="addressLine" hidden />

                            <div class="mb-3">
                                <label for="remarks">Ghi chú</label>
                                <textarea class="form-control" placeholder="Nhập ghi chú" name="Remarks" id="remarks" rows="3"></textarea>
                            </div>
                            <input type="text" class="form-control" value="1" id="paymentMethod" name="PaymentMethod" hidden />
                        </div>

                        <div class="title-cart">Thông tin thanh toán <span>Vui lòng chọn một hình thức thanh toán.</span></div>
                        <div class="info-payment">
                            <a href="javascript:void(0)" class="btn btn-payment active" data-payment="transfer">Chuyển khoản</a>
                            <a href="javascript:void(0)" class="btn btn-payment" data-payment="cod">Thanh toán khi nhận hàng</a>
                            <hr class="hr-payment" />
                            <div class="payment-content transfer active">
                                <div id="transfer"></div>
                                <p>Thông tin chuyển khoản</p>
                                <p>
                                    <strong>
                                        CÔNG TY TNHH GIA THÁI DOCTORLOAN <br />
                                        Số tài khoản: 6899136899 <br />
                                        Ngân hàng: TMCP Ngoại Thương Việt Nam (VIETCOMBANK - VCB) <br />
                                        Nội dung chuyển khoản: Tên + Địa chỉ giao hàng
                                    </strong>
                                </p>
                            </div>

                            <div class="payment-content cod">
                                <div id="cod"></div>
                                <p><strong>Đơn hàng sẽ được gửi đến bạn trong thời gian sớm nhất!</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="cart-wrapper">
                        <div class="title-cart">Đơn hàng</div>
                        <hr class="hr-payment" />
                        <div>
                            <div id="cartWrapperItem"></div>
                            <div class="total-cart">
                                <div class="total-info">
                                    <span>Tạm tính</span>
                                    <span id="cartSubtotal" class="totals-value"></span>
                                </div>
                                <div class="total-info">
                                    <span>Phí vận chuyển</span>
                                    <span id="cartShipping" class="totals-value">Miễn phí toàn quốc</span>
                                    <input type="text" name="priceDiscount" id="inputCartShipping" value="" class="form-control" hidden />
                                </div>
                                <div class="total-info totals-item-total">
                                    <span>Tổng cộng</span>
                                    <span id="cartTotal" class="totals-value"></span>
                                    <input type="text" name="TotalPrice" id="inputCartTotal" value="" class="form-control" hidden />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn checkout" type="submit">Đặt hàng</button>
                        @* <a id="btnOrder" class="btn checkout">Đặt hàng</a> *@
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

@section scripts{
    <script type="text/javascript">
        var fadeTime = 50;

        (() => {
            'use strict'
            const forms = document.querySelectorAll('.needs-validation')
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })();

        const _host = "https://provinces.open-api.vn/api/";
        
        //Function call api city
        var callAPI = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data, "city");
                });
        }

        //Function call api district
        callAPI('https://provinces.open-api.vn/api/?depth=1');
        var callApiDistrict = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.districts, "district");
                });
        }

        //Function call api ward
        var callApiWard = (api) => {
            return axios.get(api)
                .then((response) => {
                    renderData(response.data.wards, "ward");
                });
        }

        //Render data option
        var renderData = (array, select) => {
            let row = ' <option disable value="">Chọn</option>';
            array.forEach(element => {
                row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
            });
            document.querySelector("#" + select).innerHTML = row
        }

        //Selected City name
        $("#city").change(() => {
            callApiDistrict(_host + "p/" + $("#city").find(':selected').data('id') + "?depth=2");
            printResult();
        });

        //Selected District name
        $("#district").change(() => {
            callApiWard(_host + "d/" + $("#district").find(':selected').data('id') + "?depth=2");
            printResult();
        });

        //Selected Ward name
        $("#ward").change(() => {
            printResult();
        })

        //Get addressLine
        var printResult = () => {
            if ($("#district").find(':selected').data('id') != "" && $("#city").find(':selected').data('id') != "" &&
                $("#ward").find(':selected').data('id') != "") {
                let result = $("#city option:selected").text() +
                    " - " + $("#district option:selected").text() + " - " +
                    $("#ward option:selected").text();
                $("#addressLine").val(result);
            }
        }

        function myFunction() {
            return $("#addressLine").val($("#addressLine").val() + " - " + $("#addressDetaills").val()) ;
        }

        //Function select method payment
        $(document).on('click', '.btn-payment', function () {
            $('.btn-payment').removeClass("active");
            $(this).addClass("active");
            var getdatapayment = $(this).attr("data-payment");
            $('.payment-content').removeClass("active");
            $('.payment-content.' + getdatapayment).addClass("active");

            if (getdatapayment == 'transfer') {
                $('#paymentMethod').val('1');
            } else if (getdatapayment == 'cod') {
                $('#paymentMethod').val('2');
            }
        });

        //Function convert formart VND
        function formartVND(e) {
            e.text(parseInt(e.text()).toLocaleString('vi', { style: 'currency', currency: 'VND' }));
        }

        //Handel change quantity element
        function changeQuantity(e, data) {
            e.change(function () {
                var _price = data.data.price;
                var _subTotal = data.data.price * e.val();
                var _currency = Number($("#cartSubtotal").text().replace(/[^0-9,-]/g, ''));
                console.log((_currency-_price));
                $("#cartSubtotal").html(_subTotal);

                formartVND($("#cartSubtotal"));

                var _total = _subTotal + data.data.priceDiscount;
                $("#cartTotal").html(_total);
                formartVND($('#cartTotal'));
            });
        }

        //Function get parameter in url
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Get the value of the parameter in URL
        var paramIdVal = getParameterByName('id');
        var paramQuantityVal = getParameterByName('quantity');
        var _payment = JSON.parse(sessionStorage.getItem('Payment'));

        //Handel get option for id
        function getOptionProduct(_paramIdVal, _optionId) {
            $.ajax({
                url: 'https://doctorloan-api.giathaidoctorloan.vn/api/product-module/Product/GetProduct?id=' + _paramIdVal,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var _itemOption = [];
                    var ip;
                    if (data.data.productItems != null) {
                        $.each(data.data.productItems, function (idx, items) {
                            if (_optionId != undefined) {
                                console.log("_optionId: ", _optionId);
                                ip = `<input type="text" name="ProductItemId" value="`+items.name+`" id="productItem-`+data.data.id+`" class="form-control">`;
                            } else {
                                    _itemOption.push(`<option value="` + items.id + `">` + items.name + `</option>`);
                            }
                        });
                        if (_itemOption != "") {
                            $("#ppDesc-" + _paramIdVal).append(`<div class="ipr-item form-group">
                                                                    <label for="optionProduct">Loại ghế</label>
                                                                    <select class="form-control" name="ProductItemId" id="optionProduct">
                                                                        `+ _itemOption + `
                                                                    </select>
                                                                </div>`);
                        }
                    }
                },
                error: function (error) {
                    //handle show error
                    console.error('Error:', error);
                }
            });
        }

        /* Recalculate cart */
        function recalculatePayment() {
            var subtotal = 0;

            /* Sum up row totals */
            $('.pp-item').each(function () {
                var _currency = $(this).children('.product-price').text();
                subtotal += Number(_currency.replace(/[^0-9,-]/g, ''));
            });

            /* Calculate totals */
            //var shipping = (subtotal > 0 ? shippingRate : 0);
            var shipping = 0;
            var total = subtotal + shipping;


            /* Update totals display */
            $('.totals-value').fadeOut(fadeTime, function () {
                $('#cartSubtotal').html(subtotal.toLocaleString('vi', { style: 'currency', currency: 'VND' }));
                //$('#cart-shipping').html(shipping.toLocaleString('vi', { style: 'currency', currency: 'VND' }));
                $('#cartTotal').html(total.toLocaleString('vi', { style: 'currency', currency: 'VND' }));
                $('#inputCartTotal').val(total);
                if (total == 0) {
                    $('.checkout').fadeOut(fadeTime);
                } else {
                    $('.checkout').fadeIn(fadeTime);
                }
                $('.totals-value').fadeIn(fadeTime);
            });
        }

        var resultAPI;
        // Get the value of the parameter productId in URL
        function getProduct(_paramIdVal, _quantity) {
            $.ajax({
                url: 'https://doctorloan-api.giathaidoctorloan.vn/api/product-module/Product/GetProduct?id=' + _paramIdVal,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    resultAPI = data;
                    // Handle call API Products
                    var productItem = $(`<div id="listProductPayment-`+data.data.id+`" data-id="` + data.data.id + `" class="list-product-payment">
                                            <div class="pp-item">
                                                <div class="pp-info">
                                                    <img id="imgProductPayment" src="`+ data.data.productMedias[0].mediaUrl + `" />
                                                        <div id="ppDesc-`+_paramIdVal+`" class="pp-desc">
                                                        <strong>`+ data.data.name + `</strong>
                                                        <input type="text" name="Name" value="`+ data.data.name + `" class="form-control" hidden />
                                                        <div style="display:left;" >
                                                            <div id="quantity">
                                                                <label for="quantityPayment">Số Lượng</label>
                                                                <input min="1" type="number" name="Quantity" value="`+ _quantity + `" id="quantityPayment-` + data.data.id + `" class="form-control" style="width: 80px !important" />
                                                            </div>
                                                            <div id="iprItemColor" class="ipr-color"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div id="productPrice-`+data.data.id+`" class="product-price">`+ (data.data.price * _quantity) + `</div>
                                                <input type="text" name="Price" value="`+ data.data.price + `" class="form-control" hidden />
                                            </div>
                                        </div>`);
                    $("#cartWrapperItem").append(productItem);

                    if (paramIdVal != undefined) {
                        $('#cartSubtotal').text(data.data.price);
                        $('#inputCartTotal').val(data.data.price);
                        $('#cartTotal').text(data.data.price);
                    } else if (_payment != undefined) {
                        $("#quantityPayment").attr('readonly', true);
                        recalculatePayment();
                    }

                    formartVND($('#productPrice-'+data.data.id));
                    formartVND($('#cartSubtotal'));
                    //formartVND($('#cartShipping'));
                    formartVND($('#cartTotal'));

                    changeQuantity($("#quantityPayment-" + data.data.id), resultAPI);
                    
                },
                error: function (error) {
                    //handle show error
                    console.error('Error:', error);
                }
            });
        }

        if(paramIdVal != undefined) {
            getProduct(paramIdVal, paramQuantityVal);
            getOptionProduct(paramIdVal, '');
        }
        

        var messError = $("#alertMessageError").val();

        if (messError != null) {
            new Notify({
                status: 'error',
                title: 'Thông báo lỗi',
                text: messError,
                autoclose: true,
                autotimeout: 3000,
            });
        }

        //Handle get Product to Cart
        if (_payment != undefined && paramIdVal == undefined) {
            $.each(_payment, function (idx, item) {
                getProduct(item.id, item.quantity);
                if (item.optionId != undefined) {
                    getOptionProduct(item.id, item.optionId);
                }
            });
        }

    </script>
}